<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Finale RLS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="font-family: Arial; padding: 20px; max-width: 600px; margin: 0 auto;">
    <h1>üîß Test Finale Configurazione</h1>
    
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
        <h3>üö® Situazione Attuale</h3>
        <p>RLS sta bloccando completamente l'accesso. Usa lo script nucleare qui sotto:</p>
    </div>

    <textarea id="sqlScript" style="width: 100%; height: 300px; font-family: monospace; font-size: 12px; padding: 10px; background: #2d3748; color: white; border-radius: 5px;">
-- SCRIPT NUCLEARE - COPIA TUTTO
DO $$ 
DECLARE 
    r RECORD;
BEGIN
    -- Disabilita RLS
    FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') 
    LOOP
        EXECUTE 'ALTER TABLE ' || quote_ident(r.tablename) || ' DISABLE ROW LEVEL SECURITY';
    END LOOP;
    
    -- Elimina policy
    FOR r IN (SELECT tablename, policyname FROM pg_policies WHERE schemaname = 'public') 
    LOOP
        EXECUTE 'DROP POLICY IF EXISTS ' || quote_ident(r.policyname) || ' ON ' || quote_ident(r.tablename);
    END LOOP;
END $$;

-- Crea policy permissive
CREATE POLICY "allow_all_veicoli" ON veicoli FOR ALL USING (true);
CREATE POLICY "allow_all_utenti" ON utenti FOR ALL USING (true);  
CREATE POLICY "allow_all_tipoveicoli" ON tipoveicoli FOR ALL USING (true);
CREATE POLICY "allow_all_interventi" ON interventi FOR ALL USING (true);
    </textarea>
    
    <button onclick="copyScript()" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin: 10px 0;">
        üìã Copia Script Nucleare
    </button>

    <button onclick="testDatabase()" style="width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
        üîç Testa Database
    </button>

    <div id="result" style="margin-top: 20px; padding: 15px; border-radius: 8px;"></div>

    <script>
        const supabase = window.supabase.createClient(
            'https://jamttxwhexlvbkjccrqm.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphbXR0eHdoZXhsdmJramNjcnFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2NTE5MDIsImV4cCI6MjA2OTIyNzkwMn0.MkQarY2dOUuwhFnOdaLHqb6idFocTGSfZKjqVoeDYBs'
        );

        function copyScript() {
            const textarea = document.getElementById('sqlScript');
            textarea.select();
            document.execCommand('copy');
            alert('‚úÖ Script copiato! Incolla in SQL Editor e clicca RUN');
        }

        async function testDatabase() {
            showResult('üîç Test in corso...', 'loading');
            
            try {
                // Test lettura
                const tests = [
                    { name: 'veicoli', action: supabase.from('veicoli').select('count') },
                    { name: 'utenti', action: supabase.from('utenti').select('count') },
                    { name: 'tipoveicoli', action: supabase.from('tipoveicoli').select('count') }
                ];

                let results = [];
                
                for (let test of tests) {
                    const { data, error } = await test.action;
                    if (error) {
                        results.push(`‚ùå ${test.name}: ${error.message}`);
                    } else {
                        results.push(`‚úÖ ${test.name}: Accessibile`);
                    }
                }

                // Test scrittura
                try {
                    const testVehicle = {
                        nomeveicolo: 'Test ' + Date.now(),
                        targa: 'TEST' + Date.now(),
                        kmattuali: 1000,
                        utente_id: 'test-user',
                        dataora: new Date().toISOString()
                    };
                    
                    const { error } = await supabase.from('veicoli').insert([testVehicle]);
                    if (error) {
                        results.push(`‚ùå Scrittura veicoli: ${error.message}`);
                    } else {
                        results.push(`‚úÖ Scrittura veicoli: Funziona`);
                    }
                } catch (e) {
                    results.push(`‚ùå Scrittura veicoli: ${e.message}`);
                }

                const allSuccess = results.filter(r => r.includes('‚úÖ')).length === results.length;
                
                if (allSuccess) {
                    showResult(`üéâ TUTTO FUNZIONA!<br><br>${results.join('<br>')}`, 'success');
                } else {
                    showResult(`Problemi:<br>${results.join('<br>')}`, 'error');
                }

            } catch (error) {
                showResult(`‚ùå Errore nel test: ${error.message}`, 'error');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.style.background = type === 'success' ? '#d4edda' : 
                                       type === 'error' ? '#f8d7da' : '#d1ecf1';
            resultDiv.style.color = type === 'success' ? '#155724' : 
                                  type === 'error' ? '#721c24' : '#0c5460';
        }

        // Test automatico
        setTimeout(testDatabase, 1000);
    </script>
</body>
</html>